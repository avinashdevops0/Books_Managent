pipeline {
    agent any 
    
    environment {
        DOCKERHUB_CREDENTIALS   = "Docker"     // Jenkins DockerHub credentials ID
        MYSQL_ROOT_PASSWORD      = credentials('MYSQL_ROOT_PASSWORD')
        MYSQL_USER               = credentials('MYSQL_USER')
        MYSQL_USER_PASSWORD      = credentials('MYSQL_USER_PASSWORD')
        DOCKER_USER              = "avinashg0"  // DockerHub username
        IMAGE_NAME               = "books"
        IMAGE_TAG                = "${BUILD_NUMBER}"
        STACK_NAME               = "books-stack"
    }

    options {
        timestamps()
    }

    stages {

        stage ("Clean Workspace") {
            steps {
                cleanWs()
            }
        }

        stage ("Checkout Code") {
            steps {
                git branch: 'books', 
                    url: 'https://github.com/avinashdevops0/Books_Managent.git'
            }
        }


        stage ("Build Docker Image") {
            steps {
                sh """
                docker build -t ${DOCKER_USER}/${IMAGE_NAME}:${IMAGE_TAG} .
                """
            }
        }

        stage ("Login & Push Docker Image") {
            steps {
                withDockerRegistry(credentialsId: "${DOCKERHUB_CREDENTIALS}", 
                                   url: 'https://index.docker.io/v1/') {
                    sh "docker push ${DOCKER_USER}/${IMAGE_NAME}:${IMAGE_TAG}"
                }
            }
        }

        stage ("Deploy to Swarm") {
            steps {
                // Pass IMAGE_TAG to compose file dynamically
                sh """
                IMAGE_TAG=${IMAGE_TAG} docker stack deploy -c docker-compose.yml ${STACK_NAME}
                """
            }
        }
    }

    post {
        success {
            echo "✅ Deployment Successful: ${STACK_NAME} using image ${DOCKER_USER}/${IMAGE_NAME}:${IMAGE_TAG}"
        }
        failure {
            echo "❌ Deployment Failed"
        }
    }
}