pipeline {
    agent any 
    
    environment {
        DOCKERHUB_CREDENTIALS   = "Docker"     // Jenkins credential ID
        MYSQL_ROOT_PASSWORD     = credentials('MYSQL_ROOT_PASSWORD')
        MYSQL_USER              = credentials('MYSQL_USER')
        MYSQL_USER_PASSWORD     = credentials('MYSQL_USER_PASSWORD')
    }

    stages {

        stage ("Clean Workspace") {
            steps {
                cleanWs()
            }
        }

        stage ("Checkout Code") {
            steps {
                git branch: 'books', 
                    url: 'https://github.com/avinashdevops0/Books_Managent.git'
            }
        }

        stage ("Build Images") {
            steps {
                sh "docker-compose build"
                sh "docker tag books avinashg0/books:${BUILD_NUMBER}"
            }
        }

        stage ("Login & Push Images") {
            steps {
                withDockerRegistry(credentialsId: "${DOCKERHUB_CREDENTIALS}", 
                                   url: 'https://index.docker.io/v1/') {

                    sh "docker push avinashg0/books:${BUILD_NUMBER}"
                }
            }
        }

        stage ("Deploy") {
            steps {
                sh """
                docker-compose down || true
                docker-compose up -d
                """
            }
        }
    }
}


pipeline {
    agent any 
    
    environment {
        DOCKERHUB_CREDENTIALS   = "Docker"     // Jenkins credential ID
        MYSQL_ROOT_PASSWORD     = credentials('MYSQL_ROOT_PASSWORD')
        MYSQL_USER              = credentials('MYSQL_USER')
        MYSQL_USER_PASSWORD     = credentials('MYSQL_USER_PASSWORD')
    }

    stages {

        stage ("Clean Workspace") {
            steps {
                cleanWs()
            }
        }

        stage ("Checkout Code") {
            steps {
                git branch: 'books', 
                    url: 'https://github.com/avinashdevops0/Books_Managent.git'
            }
        }

        stage ("Build Images") {
            steps {
                sh "docker-compose build"
                sh "docker tag books avinashg0/books:${BUILD_NUMBER}"
            }
        }

        stage ("Login & Push Images") {
            steps {
                withDockerRegistry(credentialsId: "${DOCKERHUB_CREDENTIALS}", 
                                   url: 'https://index.docker.io/v1/') {

                    sh "docker push avinashg0/books:${BUILD_NUMBER}"
                }
            }
        }

        stage ("Deploy") {
            steps {
                // sh "docker-compose up -d"
                sh "docker stack deploy -c compose.yml books-stack"
            }
        }
    }
}
